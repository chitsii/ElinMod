# Elin Item Relocator

```
アイテムを目検で選別するのが辛くなってきた？
整理はもう、冒険合間の「労働」やなくて、「快感」に変えてしまいましょう。
**「欲しいもんだけコンテナへ一瞬でシュゥゥゥーッ！！」**
このModはこんなときに便利やで！

* 「魔法強化」付きの装備を強い順に並べたり、「高品質以下」の処分や「未鑑定かつ奇跡以上」だけ収集
* 「手スロット」を持つ「消費FP20以下」遺伝子持ってたっけ？
* 「ダークマター素材あるいはビーチボール」以外のジャンクを一括出荷
* 「呪われた装備」や「盗品」だけ隔離したい

### こだわり機能

* **プリセット：** 検索条件はサイドバーに保存して、いつでも呼び出せるんや。
* **爆速プレビュー：** リアルタイムに検索結果をプレビュー。プレビューにマウスオーバーしてツールチップ表示したり、クリックでアイテム別に転送も可能や。
* **条件ビルダー：** AND/ORを組み合わせて「自分専用の選別ルール」を作れるわ。ルール内に複数条件を作ってAND検索、複数ルールを作ればOR検索になるで。
* **多彩なソート：** 価値、重量、生成順、エンチャ強度、DNAコスト……プレビュー画面を好きな順番で並べ替えてや。

ただしUIがちょっとパンパンになってしもてな……。
画面サイズは**1920x1080以上**で広々と使ってくれると嬉しいわ。
転送できる数は、送り先のコンテナの空き容量までやから、そこだけは気をつけてな！
```

## 使い方

1. ゲーム内で任意のコンテナを開く
2. ウィンドウ右部に追加される「★」ボタンを押すと、検索UIに移ります。
3. 左側のウィンドウで検索条件を作ると、右側にリアルタイムに検索結果がプレビューされます
   検索結果の各アイテムにマウスオーバーするとツールチップが表示されます。
   アイテムをクリックすると、個別にアイテムを移動します。
   「全て転送」ボタンを押すと条件に合うアイテムを全て移動します。
4. 左側のウィンドウのサイドバーの＋ボタンを押すと、現在の条件を新しいプリセットに保存します。
   以降、サイドバーから保存したプリセットを呼び出せます。

## アンインストール
セーブデータには影響しません。

## 設定ファイル
保存したプリセットは外部データとして保存されています。
`%USERPROFILE%\AppData\LocalLow\Lafrontier\Elin\Save\Elin_ItemRelocator_Data.json`

---

## 主な機能

- **ユーザビリティ**:
  - **プリセット機能**: よく使う設定を保存し、いつでも呼び出せるサイドバー機能
  - **条件ビルダー**: 複数のルールや条件を右クリックで管理（削除・リネーム・無効/有効化）
  - **リアルタイムプレビュー**: 検索範囲や条件を変更すると即座に結果を反映
- **検索機能**:
  - **テキスト/タグ**: 自由記述でアイテム名の部分一致によるフィルタ
  - **カテゴリ**: アイテムカテゴリによるフィルタ（例: `飲料`）
  - **エンチャント**: エンチャント種別や強度による比較（`>=10` など）
  - **レアリティ**: 特別・神器・奇跡・高品質などのレアリティ
  - **品質**: 品質値の数値の範囲
  - **素材**: アイテム素材（例: `アダマンタイト`）
  - **祝福**: 祝福・呪い・堕落・通常などの祝福状態
  - **盗品**: 盗品であるか否か
  - **鑑定**: 鑑定済みであるか否か
  - **生成レベル**: アイテムの生成レベル (`>= 10` など)
  - **DNA消費FP**: 遺伝子のコスト (`>= 800` など)
  - **DNA補正内容**: 遺伝子に含まれる主能力・スキル・フィートを指定 (`筋力`, `採掘 >= 5` など)
  - **食事特性**: 食品が持つ食事効果を指定 (`筋力` `不浄` `猫` `血の糧`など)。AND/OR条件を指定可能。
- **検索範囲**:
  - **持ち物**: プレイヤーの所持品全体を対象（お気に入りアイテムや装備中のアイテムを除く）。
  - **地面**: 現在のマップにある、家具として設置されておらず、NPCの所有物でないアイテム。
  - **持ち物+地面**: 上記両方を対象とします。
- **ソート機能**:
  - **検索ヒット順**: ソートを行わない（デフォルト）
  - **生成レベル**: アイテムの生成レベルでソート（高い順/低い順）
  - **生成順**: アイテムの生成順(UID)でソート（古い順/新しい順）
  - **価値**: アイテムの価値でソート（高い順/安い順）
  - **エンチャント強度**: 条件指定したエンチャントの強度合計値でソート（強い順/弱い順）
  - **DNA消費FP**: DNAアイテムのコスト（強さ）でソート（強い順/弱い順）
  - **総エンチャント強度**: エンチャントの強度合計値でソート（強い順）
  - **総食事力**: 食品が持つ食事効果の強度合計値でソート（強い順/弱い順）
  - **総重量**: スタックの総重量でソート（重い順/軽い順）
  - **単体重量**: 1個あたりの重量基準でソート（重い順/軽い順）

---

## 技術仕様

### 除外ルール（自動的に検索対象外になるもの）
危険な移動を防ぐため、以下の条件に基づいて自動的に検索対象外になります。

- **基本的な除外判定**:
    - **ツールベルト本体**: ツールベルトの本体は移動しません。
    - **お気に入り**: `Thing.c_isImportant` が有効なアイテム
    - **破壊済み/設置物**: `Thing.isDestroyed` または `Thing.placeState == PlaceState.installed`
    - **ロック品**: `Thing.lockedHard` 状態のアイテム

- **InvOwner準拠の判定**:
    - **スキル/能力**: PC所有コンテナ以外への移動禁止（出荷箱など）
    - **NPC資産**: NPCの所有物は移動できません。
    - **移動先の制限**: 移動先が施錠されている場合は移動できません。

### アイテムのフィルタリング仕様

各フィルタリング項目は、対象のアイテムのプロパティを参照して判定を行います。

- **カテゴリ** (`Thing.category`)
    - `Thing.category.IsChildOf(id)` メソッドを使用して判定します。
    - **ID特定**: ソース (`EClass.sources.categories`) からエイリアス名等でカテゴリIDを特定し、内部リストに保持します。
    - **判定ロジック**: 対象アイテムのカテゴリが、指定されたカテゴリIDそのもの、またはその子孫カテゴリである場合に合致します（例: `food` を指定すれば `food_meal` も対象）。複数指定時はOR条件となります。
- **テキスト** (`Thing.Name`)
    - アイテムの表示名 (`Thing.Name`) に対して部分一致検索を行います（大文字・小文字無視）。
- **エンチャント** (`Thing.elements`)
    - `Thing.elements.Value(id)` の戻り値を参照します。
    - **ID特定**: 入力されたキーストリング（例: `Mining`）から `EClass.sources.elements` を検索し、`alias` または表示名 (`GetName()`) が一致する `Element` のIDを特定します。
    - **値の取得**: 特定したIDを使って `Thing.elements.Value(id)` を呼び出し、現在の強度を取得して比較します。
- **品質** (`Thing.encLV`)
    - `Thing.encLV` (int) の値を直接参照します。
    - 指定された整数値（例: `3`）と、比較演算子（`>=` 等）を用いて判定します。
- **レアリティ** (`Thing.rarity`)
    - `Thing.rarity` (Enum) を `int` にキャストした値を参照します。
    - **判定ロジック**: 選択されたレアリティのIDリスト (`HashSet<int>`) に、対象の `rarity` が含まれているかを判定します。
    - **値の対応**: `0`:粗悪, `1`:通常, `2`:高品質, `3`:奇跡, `4`:神器, `5`:特別。
- **素材** (`Thing.material`)
    - `Thing.material` を参照します。
    - **判定ロジック**: `MaterialIds` (HashSet) に、対象アイテムの `material.alias` または `material.id.ToString()` が含まれているかを判定します。これらは検索時にエイリアス（例: `adamantium`）またはIDから解決されます。
- **祝福** (`Thing.blessedState`)
    - `Thing.blessedState` (`0`:通常, `1`:祝福, `-1`:呪い, `-2`:堕落) と比較します。
- **盗品** (`Thing.isStolen`)
    - `boolean` プロパティ (`isStolen`) が一致するか判定します。
- **鑑定** (`Thing.isIdentified`)
    - `boolean` プロパティ (`IsIdentified`) が一致するか判定します。
- **重量** (`Thing.SelfWeight`)
    - アイテム1個あたりの単体重量（`1000` = `1.0s` 相当の内部整数）と比較します。
- **生成レベル** (`Thing.genLv`)
    - `Thing.genLv` (int) の値を直接参照します。ネフィアの階層レベル等に相当する値です。
    - 指定された整数値と、比較演算子を用いて判定します。
- **DNA消費FP** (`Thing.c_DNA.cost`)
    - `Card.c_DNA.cost` (int) を参照します。遺伝子でないアイテムは非該当として扱います。
- **DNA補正内容** (`Thing.c_DNA.vals`)
    - 遺伝子に含まれるElement IDと補正値を検査します。
    - エンチャントフィルタと同様に、特定の能力名（ID）が含まれているか、またその補正値が指定条件を満たすかを判定します。
- **食事特性** (`Thing.elements`)
    - 食品 (`IsFood`) や飲み物 (`TraitDrink`) が持つ食事効果 (`IsFoodTrait`) を検査します。
    - `AND` モードでは指定した全ての効果を持つアイテム、`OR` モードではいずれかの効果を持つアイテムがヒットします。

## 検索ロジックの仕様

パフォーマンス最適化のために独自の検索パイプラインを採用しています。

1. **候補キャッシュ**:
   - UIを開いた時点で、「PCの所持品」と「現在のマップ（地面）」にあるすべてのアイテムをスキャンし、メモリ上にキャッシュを作成します。
   - キャッシュはコンテナを閉じるか、「全て転送」を実行するまで保持・再利用されます。

2. **スコープによるフィルタ**:
   - ユーザーが選択した「範囲（持ち物 / 地面）」に応じて、キャッシュから対象を絞り込みます。
   - **持ち物**: アイテムのルート所有者がプレイヤー (`EClass.pc`) であるものを抽出。これには入れ子のコンテナや、ツールベルト内のアイテムも含まれます。
   - **地面**: ルート所有者がプレイヤーでないものを抽出。

